<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Finanzas Pro 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 120px; background-color: #F2F2F7; }
        .ios-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border-radius: 22px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .active-tab-btn { color: #007AFF !important; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .circle-chart { width: 120px; height: 120px; transform: rotate(-90deg); }
        .circle-bg { fill: none; stroke: #334155; stroke-width: 2.5; }
        .circle { fill: none; stroke-width: 2.5; stroke-linecap: round; transition: stroke-dasharray 1s ease-out; }
        .mode-mensual .section-separator { display: none; }
        .mode-mensual .q2-label-hide { display: none; }
    </style>
</head>
<body class="mode-mensual">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200 p-4">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <select id="pay-frequency" onchange="changeFrequency()" class="bg-indigo-50 text-indigo-600 font-bold text-[10px] p-2 rounded-xl outline-none border-none appearance-none cursor-pointer uppercase tracking-wider">
                    <option value="mensual">Mensual</option>
                    <option value="quincenal">Quincenal</option>
                </select>
                <select id="global-month" onchange="changeMonth()" class="text-2xl font-black bg-transparent outline-none text-slate-800 appearance-none">
                    <option value="Enero">Enero</option><option value="Febrero">Febrero</option>
                    <option value="Marzo">Marzo</option><option value="Abril">Abril</option>
                    <option value="Mayo">Mayo</option><option value="Junio">Junio</option>
                    <option value="Julio">Julio</option><option value="Agosto">Agosto</option>
                    <option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option>
                    <option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option>
                </select>
            </div>
            <button id="btn-save-top" onclick="saveCurrentMonth()" class="bg-[#007AFF] text-white px-6 py-2 rounded-full font-bold text-sm shadow-md active:scale-95 transition-all">Guardar</button>
        </div>
    </header>

    <main class="p-5 max-w-lg mx-auto">
        <div id="dashboard" class="tab-content active space-y-5">
            <h2 class="text-xl font-black text-slate-800 ml-1">Resumen Ejecutivo</h2>
            <div class="ios-card p-6 flex items-center justify-between bg-slate-800 text-white shadow-xl">
                <div>
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-1 text-label-freq">Presupuesto Mensual</p>
                    <p id="dash-total-budget" class="text-3xl font-black">Q0.00</p>
                    <div class="flex gap-4 mt-4">
                        <div><p class="text-[8px] text-slate-500 uppercase">Gastado Real</p><p id="dash-spent" class="font-bold text-red-400">Q0.00</p></div>
                        <div><p class="text-[8px] text-slate-500 uppercase">Disponible</p><p id="dash-avail" class="font-bold text-emerald-400">Q0.00</p></div>
                    </div>
                </div>
                <div class="relative flex items-center justify-center">
                    <svg class="circle-chart" viewBox="0 0 36 36">
                        <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"/>
                        <path id="dash-circle" class="circle" stroke="#007AFF" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                    <div class="absolute text-[10px] font-bold text-slate-300"><span id="dash-percent">0</span>%</div>
                </div>
            </div>
            <div class="ios-card p-5">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-3">Top Gastos</p>
                <div id="dash-top-expenses" class="space-y-3"></div>
            </div>
        </div>

        <div id="esperado" class="tab-content space-y-6">
            <div class="space-y-3">
                <div class="ios-card p-4 bg-indigo-50 border border-indigo-100 flex justify-between items-center">
                    <div><p class="text-[10px] font-black text-indigo-400 uppercase lbl-q1">Ingresos</p><div class="flex items-center font-black text-indigo-600 text-xl"><span>Q</span><input type="number" inputmode="decimal" id="p-inc-q1" value="0.00" oninput="calculateReal()" class="bg-transparent outline-none w-24"></div></div>
                </div>
                <div id="list-plan-q1" class="space-y-2"></div>
                <button onclick="addExtraPlan('list-plan-q1')" class="w-full py-2 bg-white rounded-xl border-2 border-dashed border-indigo-200 text-indigo-400 font-bold text-[10px] uppercase">+ Gasto Plan</button>
            </div>
            <hr class="section-separator border-slate-200">
            <div class="space-y-3">
                <div class="ios-card p-4 bg-emerald-50 border border-emerald-100 flex justify-between items-center q2-label-hide">
                    <div><p class="text-[10px] font-black text-emerald-500 uppercase lbl-q2">Ingresos Q2</p><div class="flex items-center font-black text-emerald-600 text-xl"><span>Q</span><input type="number" inputmode="decimal" id="p-inc-q2" value="0.00" oninput="calculateReal()" class="bg-transparent outline-none w-24"></div></div>
                </div>
                <div id="list-plan-q2" class="space-y-2"></div>
                <button onclick="addExtraPlan('list-plan-q2')" class="w-full py-2 bg-white rounded-xl border-2 border-dashed border-emerald-200 text-emerald-400 font-bold text-[10px] uppercase">+ Gasto Plan B</button>
            </div>
        </div>

        <div id="real" class="tab-content space-y-6">
            <div class="space-y-3">
                <div class="ios-card p-4 bg-indigo-600 text-white shadow-lg flex justify-between items-center text-center">
                    <div class="text-left"><p class="text-[9px] font-bold uppercase opacity-70">En mano</p><p id="wallet-q1" class="text-xl font-black">Q0.00</p></div>
                    <div><p class="text-[9px] font-bold uppercase opacity-70">Por Pagar</p><p id="pending-q1" class="text-lg font-black text-indigo-300">Q0.00</p></div>
                    <div class="text-right"><p class="text-[9px] font-bold uppercase opacity-70">Restante</p><p id="rest-q1" class="text-xl font-black text-indigo-100">Q0.00</p></div>
                </div>
                <div class="ios-card p-4"><span class="text-[10px] font-bold text-slate-400 uppercase lbl-q1">Ingreso Real</span><input type="number" inputmode="decimal" id="inc-q1" value="0.00" oninput="calculateReal()" class="w-full text-lg font-bold text-indigo-600 outline-none bg-transparent"></div>
                <div id="rows-q1" class="space-y-2"></div>
                <button onclick="addExtraReal('q1')" class="w-full py-2 bg-indigo-50 rounded-xl border-2 border-dashed border-indigo-200 text-indigo-400 font-bold text-[10px] uppercase">+ Gasto Real</button>
            </div>
            <hr class="section-separator border-slate-200">
            <div class="space-y-3">
                <div class="ios-card p-4 bg-emerald-600 text-white shadow-lg flex justify-between items-center text-center q2-label-hide">
                    <div class="text-left"><p class="text-[9px] font-bold uppercase opacity-70">En mano</p><p id="wallet-q2" class="text-xl font-black">Q0.00</p></div>
                    <div><p class="text-[9px] font-bold uppercase opacity-70">Por Pagar</p><p id="pending-q2" class="text-lg font-black text-emerald-300">Q0.00</p></div>
                    <div class="text-right"><p class="text-[9px] font-bold uppercase opacity-70">Restante</p><p id="rest-q2" class="text-xl font-black text-emerald-100">Q0.00</p></div>
                </div>
                <div class="ios-card p-4 q2-label-hide"><span class="text-[10px] font-bold text-slate-400 uppercase lbl-q2">Ingreso Real Q2</span><input type="number" inputmode="decimal" id="inc-q2" value="0.00" oninput="calculateReal()" class="w-full text-lg font-bold text-emerald-600 outline-none bg-transparent"></div>
                <div id="rows-q2" class="space-y-2"></div>
                <button onclick="addExtraReal('q2')" class="w-full py-2 bg-emerald-50 rounded-xl border-2 border-dashed border-emerald-200 text-emerald-400 font-bold text-[10px] uppercase">+ Gasto Real B</button>
            </div>
        </div>

        <div id="ahorro" class="tab-content space-y-4">
            <div class="ios-card p-5 border-l-8 border-emerald-500 shadow-xl">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Ahorro Real Acumulado</p>
                <p id="save-final-tab" class="text-4xl font-black text-emerald-500 py-2">Q0.00</p>
                <p id="status-txt" class="text-[10px] font-black text-slate-400 mt-3 uppercase">Actualizado</p>
            </div>
        </div>

        <div id="historial" class="tab-content space-y-4">
            <div id="history-rows" class="space-y-4"></div>
            <div id="history-foot"></div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-slate-200 flex justify-around p-3 pb-8 z-50">
        <button onclick="openTab(event, 'dashboard')" class="tab-btn active-tab-btn flex flex-col items-center gap-1 flex-1 text-slate-300"><i class="fas fa-chart-pie text-lg"></i><span class="text-[8px] font-bold uppercase">Dash</span></button>
        <button onclick="openTab(event, 'esperado')" class="tab-btn flex flex-col items-center gap-1 flex-1 text-slate-300"><i class="fas fa-edit text-lg"></i><span class="text-[8px] font-bold uppercase">Plan</span></button>
        <button onclick="openTab(event, 'real')" class="tab-btn flex flex-col items-center gap-1 flex-1 text-slate-300"><i class="fas fa-wallet text-lg"></i><span class="text-[8px] font-bold uppercase">Real</span></button>
        <button onclick="openTab(event, 'ahorro')" class="tab-btn flex flex-col items-center gap-1 flex-1 text-slate-300"><i class="fas fa-piggy-bank text-lg"></i><span class="text-[8px] font-bold uppercase">Metas</span></button>
        <button onclick="openTab(event, 'historial')" class="tab-btn flex flex-col items-center gap-1 flex-1 text-slate-300"><i class="fas fa-calendar-alt text-lg"></i><span class="text-[8px] font-bold uppercase">Anual</span></button>
    </nav>

    <script>
        let itemsQ1 = JSON.parse(localStorage.getItem('conf_q1')) || [{n:"Ejemplo Gasto",v:0}];
        let itemsQ2 = JSON.parse(localStorage.getItem('conf_q2')) || [];
        let realValues = {}; let hiddenRealItems = {}; let paidItems = {}; 

        function f(n) { return 'Q' + (n || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        function changeFrequency() {
            const freq = document.getElementById('pay-frequency').value;
            localStorage.setItem('f_pref_freq', freq);
            document.body.classList.toggle('mode-mensual', freq === 'mensual');
            updateLabels(freq);
            calculateReal();
        }

        function updateLabels(freq) {
            const isQ = freq === 'quincenal';
            document.querySelectorAll('.lbl-q1').forEach(el => el.innerText = isQ ? '1ra Quincena' : 'Ingresos Totales');
            document.querySelectorAll('.lbl-q2').forEach(el => el.innerText = isQ ? '2da Quincena' : 'Otros Ingresos');
        }

        function renderRows() {
            const r = (items, c) => {
                document.getElementById(c).innerHTML = items.map((item, i) => `
                    <div class="ios-card p-3 flex justify-between items-center bg-white/50">
                        <span class="text-xs font-bold text-slate-700">${item.n}</span>
                        <div class="flex items-center gap-2">
                             <input type="number" inputmode="decimal" value="${item.v.toFixed(2)}" oninput="updatePlanValue('${c}', ${i}, this.value)" class="w-20 text-right font-black text-slate-800 text-xs bg-slate-100 rounded-lg p-1 outline-none">
                             <button onclick="deletePlanItem('${c}', ${i})" class="text-red-300 p-1"><i class="fas fa-trash-can"></i></button>
                        </div>
                    </div>`).join('');
            };
            r(itemsQ1, 'list-plan-q1'); r(itemsQ2, 'list-plan-q2');
            renderRealRows();
        }

        function renderRealRows() {
            const m = document.getElementById('global-month').value;
            const ex = JSON.parse(localStorage.getItem(`extras_${m}`)) || { q1: [], q2: [] };
            const hid = hiddenRealItems[m] || [];
            const rL = (pI, eI, cI, pref) => {
                let h = "";
                pI.forEach((item, idx) => {
                    const k = `${pref}_plan_${idx}`;
                    if (!hid.includes(k)) h += createInputRow(item.n, item.v, k, pref, false);
                });
                eI.forEach((item, idx) => {
                    const k = `${pref}_extra_${idx}`;
                    h += createInputRow(item.n, 0, k, pref, true, idx);
                });
                document.getElementById(cI).innerHTML = h;
            };
            rL(itemsQ1, ex.q1, 'rows-q1', 'q1'); rL(itemsQ2, ex.q2, 'rows-q2', 'q2');
            calculateReal();
        }

        function createInputRow(n, pV, k, pref, isE, eI) {
            const sV = realValues[k] || ""; const isP = paidItems[k]; 
            return `<div class="r-row ios-card p-4 flex items-center justify-between mb-2" data-key="${k}" data-plan="${pV}" data-name="${n}">
                <div class="flex items-center gap-3"><button onclick="deleteRealRow('${k}', ${isE}, ${eI}, '${pref}')" class="text-red-400"><i class="fas fa-trash-can text-xs"></i></button>
                <div><p class="text-sm font-bold text-slate-800">${n}</p><p class="text-[9px] text-slate-400 uppercase">${isE ? 'Extra' : 'Fijo: ' + f(pV)}</p></div></div>
                <div class="text-right flex items-center gap-3"><button onclick="togglePaid('${k}')"><i class="fas ${isP ? 'fa-check-circle text-emerald-500' : 'fa-circle text-slate-200'} text-2xl"></i></button>
                <div class="flex flex-col items-end"><input type="number" inputmode="decimal" value="${sV}" class="val-input w-24 text-right font-black ${pref=='q1'?'text-indigo-600':'text-emerald-600'} outline-none bg-transparent" oninput="saveRealValue('${k}', this.value)" placeholder="0.00">
                <p class="dif-lbl text-[9px] font-black text-slate-300 mt-1">Q0.00</p></div></div></div>`;
        }

        function togglePaid(k) { paidItems[k] = !paidItems[k]; renderRealRows(); saveCurrentMonth(); }

        function deleteRealRow(k, isE, idx, pref) {
            const m = document.getElementById('global-month').value;
            if (isE) {
                let ex = JSON.parse(localStorage.getItem(`extras_${m}`)) || { q1: [], q2: [] };
                ex[pref].splice(idx, 1); localStorage.setItem(`extras_${m}`, JSON.stringify(ex));
            } else { if(!hiddenRealItems[m]) hiddenRealItems[m] = []; hiddenRealItems[m].push(k); }
            delete realValues[k]; delete paidItems[k]; renderRealRows(); saveCurrentMonth();
        }

        function saveRealValue(k, v) { realValues[k] = v; calculateReal(); saveCurrentMonth(); }

        function calculateReal() {
            const rI1 = parseFloat(document.getElementById('inc-q1').value) || 0; 
            const rI2 = parseFloat(document.getElementById('inc-q2').value) || 0;
            let pg1 = 0, pg2 = 0, pp1 = 0, pp2 = 0; let allEx = [];
            document.querySelectorAll('.r-row').forEach(row => {
                const pV = parseFloat(row.dataset.plan) || 0; const inp = row.querySelector('.val-input');
                const difL = row.querySelector('.dif-lbl'); const k = row.dataset.key;
                const isQ1 = k.startsWith('q1'); const isP = paidItems[k]; 
                if (inp.value !== "") {
                    const v = parseFloat(inp.value); if (isQ1) pg1 += v; else pg2 += v; allEx.push({ n: row.dataset.name, v: v });
                    if (pV > 0) {
                        const d = pV - v; if (!isP && d > 0) { if (isQ1) pp1 += d; else pp2 += d; difL.innerText = "Faltan " + f(d); difL.className = "dif-lbl text-[9px] font-black mt-1 text-slate-400"; }
                        else { difL.innerText = (d < 0 ? '-' : '+') + f(Math.abs(d)); difL.className = `dif-lbl text-[9px] font-black mt-1 ${d < 0 ? 'text-red-500' : 'text-emerald-500'}`; }
                    } else { difL.innerText = "Extra"; difL.className = "dif-lbl text-[9px] font-black mt-1 text-orange-400"; }
                } else { if (isQ1) pp1 += pV; else pp2 += pV; difL.innerText = "Pendiente"; difL.className = "dif-lbl text-slate-300 text-[9px] font-bold mt-1"; }
            });
            const w1 = rI1 - pg1, w2 = rI2 - pg2;
            document.getElementById('wallet-q1').innerText = f(w1); document.getElementById('pending-q1').innerText = f(pp1); document.getElementById('rest-q1').innerText = f(w1 - pp1);
            document.getElementById('wallet-q2').innerText = f(w2); document.getElementById('pending-q2').innerText = f(pp2); document.getElementById('rest-q2').innerText = f(w2 - pp2);
            const fin = (w1 - pp1) + (w2 - pp2); document.getElementById('save-final-tab').innerText = f(fin);
            const tIn = rI1 + rI2, tOut = pg1 + pg2;
            document.getElementById('dash-total-budget').innerText = f(tIn); document.getElementById('dash-spent').innerText = f(tOut); document.getElementById('dash-avail').innerText = f(tIn - tOut);
            const pct = tIn > 0 ? Math.min((tOut / tIn) * 100, 100) : 0;
            document.getElementById('dash-percent').innerText = Math.round(pct); document.getElementById('dash-circle').style.strokeDasharray = `${pct}, 100`;
            allEx.sort((a,b) => b.v - a.v);
            document.getElementById('dash-top-expenses').innerHTML = allEx.slice(0, 5).map(i => `<div class="flex justify-between text-xs border-b border-slate-100 pb-2"><span class="font-bold text-slate-600">${i.n}</span><span class="font-black text-slate-800">${f(i.v)}</span></div>`).join('');
            return { inc: tIn, exp: tOut, save: fin };
        }

        // CORRECCIÓN AQUÍ: Ahora refresca el Real al cambiar valores en el Plan
        function updatePlanValue(c, i, v) {
            const n = parseFloat(v) || 0; if(c === 'list-plan-q1') itemsQ1[i].v = n; else itemsQ2[i].v = n;
            localStorage.setItem('conf_q1', JSON.stringify(itemsQ1)); localStorage.setItem('conf_q2', JSON.stringify(itemsQ2));
            renderRealRows(); // Refresca la vista Real con el nuevo monto del plan
        }

        function addExtraPlan(c) {
            const n = prompt("Nombre:"); if(!n) return;
            const v = parseFloat(prompt("Monto:")) || 0;
            if(c === 'list-plan-q1') itemsQ1.push({n, v}); else itemsQ2.push({n, v});
            localStorage.setItem('conf_q1', JSON.stringify(itemsQ1)); localStorage.setItem('conf_q2', JSON.stringify(itemsQ2));
            renderRows();
        }

        function deletePlanItem(c, i) {
            if(c === 'list-plan-q1') itemsQ1.splice(i, 1); else itemsQ2.splice(i, 1);
            localStorage.setItem('conf_q1', JSON.stringify(itemsQ1)); localStorage.setItem('conf_q2', JSON.stringify(itemsQ2));
            renderRows();
        }

        function addExtraReal(p) {
            const n = prompt("Nombre:"); if(!n) return;
            const m = document.getElementById('global-month').value;
            let ex = JSON.parse(localStorage.getItem(`extras_${m}`)) || { q1: [], q2: [] };
            ex[p].push({ n: n }); localStorage.setItem(`extras_${m}`, JSON.stringify(ex));
            renderRealRows();
        }

        function changeMonth() {
            const m = document.getElementById('global-month').value;
            const dS = localStorage.getItem('f_v_local_' + m);
            realValues = {}; paidItems = {};
            const freq = localStorage.getItem('f_pref_freq') || 'mensual';
            document.getElementById('pay-frequency').value = freq;
            changeFrequency();
            if(dS) {
                const s = JSON.parse(dS);
                document.getElementById('p-inc-q1').value = s.pI1 || 0; document.getElementById('p-inc-q2').value = s.pI2 || 0;
                document.getElementById('inc-q1').value = s.inc1 || 0; document.getElementById('inc-q2').value = s.inc2 || 0;
                realValues = s.v_map || {}; paidItems = s.paid || {};
            } else {
                document.getElementById('p-inc-q1').value = 0; document.getElementById('p-inc-q2').value = 0;
                document.getElementById('inc-q1').value = 0; document.getElementById('inc-q2').value = 0;
            }
            renderRealRows();
        }

        function saveCurrentMonth() {
            const m = document.getElementById('global-month').value;
            const state = {
                pI1: document.getElementById('p-inc-q1').value, pI2: document.getElementById('p-inc-q2').value,
                inc1: document.getElementById('inc-q1').value, inc2: document.getElementById('inc-q2').value,
                v_map: realValues, paid: paidItems, summary: calculateReal()
            };
            localStorage.setItem('f_v_local_' + m, JSON.stringify(state));
            const btn = document.getElementById('btn-save-top');
            btn.innerText = "¡OK!"; btn.classList.replace("bg-[#007AFF]", "bg-green-500");
            setTimeout(() => { btn.innerText = "Guardar"; btn.classList.replace("bg-green-500", "bg-[#007AFF]"); }, 1000);
        }

        function openTab(evt, n) {
            document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
            document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active-tab-btn"));
            document.getElementById(n).classList.add("active"); evt.currentTarget.classList.add("active-tab-btn");
            if(n === 'historial') updateHistory();
        }

        function updateHistory() {
            const c = document.getElementById('history-rows'); c.innerHTML = ""; let tS=0;
            ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"].forEach(m => {
                const d = localStorage.getItem('f_v_local_' + m);
                if(d) {
                    const s = JSON.parse(d); tS += (s.summary ? s.summary.save : 0);
                    c.innerHTML += `<div class="ios-card p-4 flex justify-between"><b>${m}</b> <span class="text-emerald-600 font-bold">${f(s.summary ? s.summary.save : 0)}</span></div>`;
                }
            });
            document.getElementById('history-foot').innerHTML = `<div class="bg-slate-900 rounded-3xl p-6 text-white text-center"><p class="text-xs opacity-50 uppercase">Ahorro Anual</p><p class="text-3xl font-black text-emerald-400">${f(tS)}</p></div>`;
        }

        window.onload = () => { renderRows(); changeMonth(); };
    </script>
</body>
</html>
